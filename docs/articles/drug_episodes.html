<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Constructing drug episodes and deriving Weibull transition estimates: Assumptions and Workflow • episodes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Constructing drug episodes and deriving Weibull transition estimates: Assumptions and Workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">episodes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/drug_episodes.html">Constructing drug episodes and deriving Weibull transition estimates: Assumptions and Workflow</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ntmv/episodes/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Constructing drug episodes and deriving Weibull transition estimates: Assumptions and Workflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ntmv/episodes/blob/HEAD/vignettes/drug_episodes.Rmd" class="external-link"><code>vignettes/drug_episodes.Rmd</code></a></small>
      <div class="d-none name"><code>drug_episodes.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="walkthrough-of-package-functions-and-assumptions">Walkthrough of package functions and assumptions<a class="anchor" aria-label="anchor" href="#walkthrough-of-package-functions-and-assumptions"></a>
</h2>
</div>
<div class="section level2">
<h2 id="prepping-the-episode-data">Prepping the episode data<a class="anchor" aria-label="anchor" href="#prepping-the-episode-data"></a>
</h2>
<p>The first function in the package workflow is
<code>prep_episode_data</code>. This is used to clean up the
tumour-specific Flatiron drug episodes datasets. This dataset finally
outputs the cleaned and merged drug episodes for only 1st, 2nd and 3rd
line for the tumour-specific patients who have received the treatment of
interest.</p>
<p>The function can take in a regular so for example, for lung we match
to either cisplatin or carboplatin (as they are often interchanged in
the protocols). <code>exact = TRUE</code> can be specified to match
exactly that treatment without any combination of other drugs. For lung,
we specify <code>exact = FALSE</code> as cisplatin and carobplatin is
rarely given alone. However, for all ohter tumours for which we have
produced drug episodes we match exactly to the treatment name.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drug_episodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prep_episode_data.html">prep_episode_data</a></span><span class="op">(</span>tumour <span class="op">=</span> <span class="st">"nsclc"</span>, treatment <span class="op">=</span> <span class="st">"cisplatin|carboplatin"</span>, drug_separator <span class="op">=</span> <span class="st">","</span>,</span>
<span>                              overlap_threshold <span class="op">=</span> <span class="fl">1</span>, exact <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## The total number of nsclc patients is 18419</span></span></code></pre>
<pre><code><span><span class="co">## The total number of nsclc patients is 16541</span></span></code></pre>
<pre><code><span><span class="co">## The total number of nsclc first-line patients is 9333</span></span></code></pre>
<pre><code><span><span class="co">## The total number of nsclc second-line patients is 1016</span></span></code></pre>
<pre><code><span><span class="co">## The total number of nsclc third-line patients is 324</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Table: Number of patients who received cisplatin|carboplatin by line of therapy</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## |Line_of_Therapy | Number_of_Patients|</span></span>
<span><span class="co">## |:---------------|------------------:|</span></span>
<span><span class="co">## |First Line      |               9333|</span></span>
<span><span class="co">## |Second Line     |               1016|</span></span>
<span><span class="co">## |Third Line      |                324|</span></span></code></pre>
<pre><code><span><span class="co">## The total number of nsclc patients with overlapping lines that were filtered out is 10673</span></span></code></pre>
<pre><code><span><span class="co">## The total number of nsclc patients with single doses that were filtered out is 10022</span></span></code></pre>
<pre><code><span><span class="co">## The total number of nsclc patients with treatment start pre-2010 that were filtered out is 20</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">drug_episodes</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 12</span></span></span>
<span><span class="co">##   patientid linestartdate lineenddate linename linenumber chemo_line prior_lines</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> 000398B8… 2023-03-28    2023-04-11  carbopl…          1          1           0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> 000398B8… 2023-07-05    2023-10-18  pemetre…          2          1           0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> 00094A26… 2018-03-19    2018-08-27  bevaciz…          1          1           0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> 00094A26… 2018-12-12    2020-06-24  osimert…          2          1           0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> 0010FDA7… 2016-01-19    2016-04-12  carbopl…          1          1           0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> 0010FDA7… 2017-02-13    2018-02-01  nivolum…          2          1           0</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 5 more variables: Date_LastFollowUp &lt;date&gt;, death_date &lt;date&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   progression_date &lt;date&gt;, next_linestart &lt;date&gt;, days_to_next_line &lt;dbl&gt;</span></span></span></code></pre>
</div>
<div class="section level2">
<h2 id="overlapping-lines">Overlapping lines<a class="anchor" aria-label="anchor" href="#overlapping-lines"></a>
</h2>
<p>The <code>prep_episode_data</code> function wraps a function to deal
with overlapping lines where the <code>linestartdate</code> and
<code>lineenddate</code> of the previous and next line overlapped. An
episode was flagged as overlapping if its start date preceded the end
date of the prior episode.</p>
<p>Contiguous overlapping lines were then grouped using a cumulative
indexing strategy. Specifically, a new group identifier was initiated
each time a non-overlapping line was encountered, while overlapping
lines shared the same identifier. Within each group, start and end dates
were recalculated to span the earliest and latest dates, respectively,
and all unique drug names were combined into a single standardized line
label. Duplicate or redundant drug entries were cleaned using regular
expressions to ensure consistency.Finally, the collapsed episodes were
renumbered sequentially for each patient to reflect the revised line
structure.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample overlapping input</span></span>
<span><span class="va">example_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  patientid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  linenumber <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  linename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cisplatin"</span>, <span class="st">"cisplatin"</span>, <span class="st">"gemcitabine"</span><span class="op">)</span>,</span>
<span>  linestartdate <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2020-01-01"</span>, <span class="st">"2020-01-15"</span>, <span class="st">"2020-02-01"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  lineenddate <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2020-01-30"</span>, <span class="st">"2020-02-15"</span>, <span class="st">"2020-03-01"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">example_data</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 5</span></span></span>
<span><span class="co">##   patientid linenumber linename    linestartdate lineenddate</span></span>
<span><span class="co">##       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>         1          1 cisplatin   2020-01-01    2020-01-30 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>         1          2 cisplatin   2020-01-15    2020-02-15 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>         1          3 gemcitabine 2020-02-01    2020-03-01</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Collapse overlapping lines</span></span>
<span><span class="va">collapsed_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collapse_overlapping_lines.html">collapse_overlapping_lines</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">collapsed_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 6</span></span></span>
<span><span class="co">##   patientid group_id linestartdate lineenddate linename               linenumber</span></span>
<span><span class="co">##       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>         1        1 2020-01-01    2020-03-01  cisplatin, gemcitabine          1</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="clean-up-single-doses-defined-as-lines">Clean up single doses defined as lines<a class="anchor" aria-label="anchor" href="#clean-up-single-doses-defined-as-lines"></a>
</h2>
<p>In the Flatiron dataset, we found several lines where the
<code>linestartdate</code> was equal to the <code>lineenddate</code>.
These are likely single doses which were not administered for a period
of time, and thus these should not be categorized as a line of therapy.
The <code>single_dose_clean</code> function aims to clean or collapse
such single-day episodes by either: 1. Merging them into temporally
adjacent lines with overlapping drug names, or 2. Dropping them if they
appear spurious and disconnected. The <code>drug_separator</code>
parameter can be used to specify how a combination drug is written in
the dataset e.g. if the name is <code>cisplatin, gemcitabine</code>, the
parameter is set to <code>,</code>.</p>
<p>First, all treatment episodes are chronologically ordered and flagged
as single-day lines if their <code>linestartdate</code> and
<code>lineenddate</code> are equal. These lines are then evaluated in
the context of their immediate neighbors (preceding and following lines)
within the same patient.</p>
<p>A merging criterion is applied whereby a single-day line is
considered for consolidation if it shares one drug components with a
temporally adjacent line. This overlap can be adjusted by the
<code>overlap_threshold</code> parameter (default is 1). Overlap is
assessed at the level of individual drug names, allowing for flexibility
in combination regimens. If this overlap criterion is met, the
single-day line is merged into the adjacent episode, with the resulting
line defined by the earliest start date, the latest end date, and a
deduplicated, alphabetically ordered list of drug components.</p>
<p>Single-day lines that fail to meet the merging criterion—i.e., those
that are both isolated and non-overlapping with adjacent lines—are
flagged for removal, under the assumption that they may reflect data
entry inconsistencies or non-line of therapeutic events.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample data</span></span>
<span><span class="va">example_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  patientid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  linenumber <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  linename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cisplatin"</span>, <span class="st">"cisplatin"</span>, <span class="st">"gemcitabine"</span><span class="op">)</span>,</span>
<span>  linestartdate <span class="op">=</span> <span class="fu">ymd</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2022-01-01"</span>, <span class="st">"2022-01-15"</span>, <span class="st">"2022-01-15"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  lineenddate   <span class="op">=</span> <span class="fu">ymd</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2022-01-10"</span>, <span class="st">"2022-01-15"</span>, <span class="st">"2022-01-15"</span><span class="op">)</span><span class="op">)</span>  <span class="co"># line 3 is single-day</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">example_data</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 5</span></span></span>
<span><span class="co">##   patientid linenumber linename    linestartdate lineenddate</span></span>
<span><span class="co">##       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>         1          1 cisplatin   2022-01-01    2022-01-10 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>         1          2 cisplatin   2022-01-15    2022-01-15 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>         1          3 gemcitabine 2022-01-15    2022-01-15</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clean single-day lines</span></span>
<span><span class="va">cleaned_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/single_dose_clean.html">single_dose_clean</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cleaned_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 5</span></span></span>
<span><span class="co">##   patientid linestartdate lineenddate linename  linenumber</span></span>
<span><span class="co">##       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>         1 2022-01-01    2022-01-15  cisplatin          1</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="time-period-restriction">Time period restriction<a class="anchor" aria-label="anchor" href="#time-period-restriction"></a>
</h2>
<p>We found that in the Flatiron dataset, very few patients started
treatment before 2010, with the significant bulk of the treatment start
date mass centered after 2010. Given the advancements and differences in
treatments, as well as the issue of these patients biasing survival
times by having an unusually long tail, we filtered the dataset for each
tumour to patients only after 2010.</p>
</div>
<div class="section level2">
<h2 id="cutoffs-for-time-to-death-time-to-progression-etc-">Cutoffs for time to death, time to progression etc.<a class="anchor" aria-label="anchor" href="#cutoffs-for-time-to-death-time-to-progression-etc-"></a>
</h2>
<p>In terms of cutoffs for what would be considered a valid time to
death from on-treatment, time to progression from on-treatment, time to
next line from on-treatment and time to off-treatment, we decided to use
the 75 % quantile as a cutoff. This ensures that the cutoff is
tumour-specific. This cutoff point was supported by other statistical
measures, namely a log-rank test which often showed a separation in
groups around the Q3 point, a Classification and Regression Tree (CART)
whose first split point also was consistent with the Q3 and a Guassian
Mixture clustering model, which often clustered observations beyond Q3
together.</p>
</div>
<div class="section level2">
<h2 id="progression-from-on-treatment">Progression from on-treatment<a class="anchor" aria-label="anchor" href="#progression-from-on-treatment"></a>
</h2>
<p>In the Flatiron dataset, we have several progression dates available
for a single patient depending on when they received their scans. For a
valid on-treatment to progression state transition for a particular
treatment, we only consider progression if it occurs atleast 7 days
after the start of line-treatment and atleast within 2-weeks of the line
end date. As we only model transitions from the target line, any
transition to a new line is also considered progression.</p>
</div>
<div class="section level2">
<h2 id="death-date-granularity">Death Date granularity<a class="anchor" aria-label="anchor" href="#death-date-granularity"></a>
</h2>
<p>In the Flatiron dataset, we only have the month and year of death for
the patient and not the exact date. Thus, to infer an exact date, we
take the maximum date of the date of last followup, the progression
date, the date of last clinical note, and the date of treatment end
depending on what information is available. If all these dates are not
available, the date is inffered to be 15th, for approximately the middle
of the month.</p>
</div>
<div class="section level2">
<h2 id="constructing-the-drug-episodes">Constructing the drug episodes<a class="anchor" aria-label="anchor" href="#constructing-the-drug-episodes"></a>
</h2>
<p>The <code>construct_state_episodes</code> function can be used to
construct the drug episodes into a form which can be fed into the
Weibull models to derive the sojourn survival time. It takes in the
cleaned output from <code>prep_episodes_data</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_episodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/construct_state_episodes.html">construct_state_episodes</a></span><span class="op">(</span><span class="va">drug_episodes</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Table: Filtered Transition Counts Table</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## |state                    |next_state    |    n|</span></span>
<span><span class="co">## |:------------------------|:-------------|----:|</span></span>
<span><span class="co">## |Death                    |NA            | 6854|</span></span>
<span><span class="co">## |On_Treatment_Target_Line |Death         |  167|</span></span>
<span><span class="co">## |On_Treatment_Target_Line |off_treatment | 3161|</span></span>
<span><span class="co">## |On_Treatment_Target_Line |progression   | 6237|</span></span>
<span><span class="co">## |On_Treatment_Target_Line |NA            |  278|</span></span>
<span><span class="co">## |off_treatment            |Death         | 1292|</span></span>
<span><span class="co">## |off_treatment            |progression   |  999|</span></span>
<span><span class="co">## |off_treatment            |NA            |  870|</span></span>
<span><span class="co">## |progression              |Death         | 5395|</span></span>
<span><span class="co">## |progression              |NA            | 1841|</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drug_transitions</span> <span class="op">&lt;-</span> <span class="va">state_episodes</span><span class="op">$</span><span class="va">drug_transitions</span></span>
<span></span>
<span><span class="va">lines</span> <span class="op">&lt;-</span> <span class="va">state_episodes</span><span class="op">$</span><span class="va">lines</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="deriving-the-weibull-shape-and-scale-parameters">Deriving the Weibull shape and scale parameters<a class="anchor" aria-label="anchor" href="#deriving-the-weibull-shape-and-scale-parameters"></a>
</h2>
<p>To derive the shape and scale parameters, we use a Weibull model with
the accelerated failure time parameterization from the
<code>flexsurv</code> package. We derive shape and scale parameters for
exit from on-treatment, exit from off-treatment and exit from
progression. To use the <code>state_exit_weibull_estimates</code>
function, we pass in the <code>drug_episodes</code> and
<code>lines</code> datasets, both of which are outputs from the
<code>construct_state_episodes</code> function.</p>
<p>In all three regressions, we adjust for the number of prior lines
(unless all the patients have no prior lines). For the exit from
progression, we also have a binary indicator variable
(<code>LoT_progression</code> with teo levels <code>LoT</code> and
<code>clinical</code>) to control for the fact that progression was
derived for some patients clinically through the progression date and
inferred for others through a change in line. This is to control for the
artifact that patients that were proxied to be progressed by a change in
line of therapy will likely stay in the progression state for a longer
period of time.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/state_exit_weibull_estimates.html">state_exit_weibull_estimates</a></span><span class="op">(</span><span class="va">drug_transitions</span>, <span class="va">lines</span><span class="op">)</span></span>
<span></span>
<span><span class="va">params_results</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 7</span></span></span>
<span><span class="co">##   state_transition         shape shape_lci shape_uci scale scale_lci scale_uci</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> On_Treatment_Target_Line 1.01      0.992     1.02   222.      217.      227.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> off_treatment            0.699     0.678     0.721  318.      295.      343.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> progression              0.848     0.831     0.866  303.      285.      322.</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nirupama Tamvada.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
